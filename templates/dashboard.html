{% extends "base.html" %}
{% block title %}URL Organizer{% endblock %}
{% block content %}
<div class="container py-4">
  <!-- Header with Home button -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold text-primary">URL ORGANIZER</h2>
    <a href="{{ url_for('home') }}" class="btn btn-dark btn-sm">üè† Home</a>
  </div>

  <!-- Category Toolbar -->
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-2">

      <!-- Category Dropdown -->
      <div class="d-flex align-items-center gap-2">
        <label for="category" class="fw-bold me-2">Category:</label>
        <select id="category" class="form-select w-auto">
          {% for cat in categories|sort(attribute='name') %}
            <option value="{{ cat.id }}">{{ cat.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex gap-2">
        <button class="btn btn-success btn-sm" onclick="showLinks()" title="Show all links">üëÅ Show</button>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCategoryModal" title="Add new category">‚ûï Add Title</button>
        <button class="btn btn-warning btn-sm" onclick="openEditCategory()" title="Edit selected category">‚úè Edit</button>
        <button class="btn btn-danger btn-sm" onclick="openDeleteCategory()" title="Delete selected category">üóë Delete</button>
        <button class="btn btn-outline-success btn-sm" onclick="exportLinks()" title="Export links in selected category">üì§ Export Links</button>
      </div>
    </div>
  </div>

  <!-- Add Link Section -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="mb-3 text-secondary">Add a New Link</h5>
      <form onsubmit="addLink(event)" class="row g-2">
        <div class="col-md-4">
          <input type="text" id="label" class="form-control" placeholder="Link Label" required>
        </div>
        <div class="col-md-6">
          <input type="url" id="url" class="form-control" placeholder="https://example.com" required>
        </div>
        <div class="col-md-2 d-grid">
          <button type="submit" class="btn btn-primary">‚ûï Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Display Links -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="mb-3 text-secondary">Links in <span id="categoryTitle">[Select a Category]</span></h5>
      <div id="linksGrid" class="list-group">
        <p class="text-muted">No category selected yet.</p>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Add Category -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="newCategory" class="form-control" placeholder="Enter category name">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addCategory()">Add</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Edit Category -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="editCategoryName" class="form-control" placeholder="Enter new category name">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="editCategory()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Delete Category Confirmation -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-danger">‚ö† Are you sure you want to delete this category and all its links?</p>
        <p id="deleteCategoryName" class="fw-bold text-primary"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="deleteCategoryConfirm()">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="toastMsg" class="toast align-items-center text-bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">Success!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- JS -->
<script>
  let currentCategoryId = null;

  // Show links
  async function showLinks() {
    const catSelect = document.getElementById("category");
    const catId = catSelect.value;
    const catName = catSelect.options[catSelect.selectedIndex].text;
    currentCategoryId = catId;

    document.getElementById("categoryTitle").innerText = catName;

    const response = await fetch(`/api/links/${catId}`);
    const links = await response.json();

    const grid = document.getElementById("linksGrid");
    grid.innerHTML = "";

    if (links.length === 0) {
      grid.innerHTML = "<p class='text-muted'>No links yet for this category.</p>";
    } else {
      links.forEach(l => {
        const row = document.createElement("div");
        row.className = "list-group-item d-flex justify-content-between align-items-center";

        row.innerHTML = `
          <div><strong>${l.label}</strong></div>
          <div>
            <a href="${l.url}" target="_blank" class="btn btn-outline-primary btn-sm me-2">üîó Visit</a>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteLink(${l.id}, '${l.label}', '${l.url}', ${l.category_id})">üóë Delete</button>
            <button id="undo-${l.id}" class="btn btn-outline-secondary btn-sm ms-2 d-none" onclick="undoLink(${l.category_id}, '${l.label}', '${l.url}', ${l.id})">‚Ü© Undo</button>
          </div>
        `;

        grid.appendChild(row);
      });
    }
  }

  // Add link
  async function addLink(event) {
    event.preventDefault();
    const catId = document.getElementById("category").value;
    const label = document.getElementById("label").value;
    const url = document.getElementById("url").value;

    const response = await fetch("/api/add_link", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ category_id: parseInt(catId), label, url })
    });

    if (response.ok) {
      document.getElementById("label").value = "";
      document.getElementById("url").value = "";
      showToast("‚úÖ Link added successfully!");
      showLinks();
    } else {
      const error = await response.json();
      showToast("‚ö† " + error.error, true);
    }
  }

  // Add category
  async function addCategory() {
    const name = document.getElementById("newCategory").value.trim();
    if (!name) return;

    const response = await fetch("/api/add_category", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name })
    });

    if (response.ok) {
      const result = await response.json();
      const dropdown = document.getElementById("category");
      const option = document.createElement("option");
      option.value = result.id;
      option.textContent = result.name || name;
      dropdown.appendChild(option);
      dropdown.value = result.id;
      document.getElementById("newCategory").value = "";
      bootstrap.Modal.getInstance(document.getElementById("addCategoryModal")).hide();
      showToast("‚úÖ Category added successfully!");
    } else {
      const error = await response.json();
      showToast("‚ö† " + error.error, true);
    }
  }

  // Edit category
  function openEditCategory() {
    const dropdown = document.getElementById("category");
    const currentName = dropdown.options[dropdown.selectedIndex].text;
    currentCategoryId = dropdown.value;
    document.getElementById("editCategoryName").value = currentName;
    new bootstrap.Modal(document.getElementById("editCategoryModal")).show();
  }

  async function editCategory() {
    const newName = document.getElementById("editCategoryName").value.trim();
    if (!newName || !currentCategoryId) return;

    const response = await fetch(`/api/edit_category/${currentCategoryId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: newName })
    });

    if (response.ok) {
      const dropdown = document.getElementById("category");
      dropdown.options[dropdown.selectedIndex].text = newName;
      bootstrap.Modal.getInstance(document.getElementById("editCategoryModal")).hide();
      showToast("‚úÖ Category updated!");
    } else {
      const error = await response.json();
      showToast("‚ö† " + error.error, true);
    }
  }

  // Delete category
  function openDeleteCategory() {
    const dropdown = document.getElementById("category");
    const currentName = dropdown.options[dropdown.selectedIndex].text;
    currentCategoryId = dropdown.value;
    document.getElementById("deleteCategoryName").innerText = currentName;
    new bootstrap.Modal(document.getElementById("deleteCategoryModal")).show();
  }

  async function deleteCategoryConfirm() {
    if (!currentCategoryId) return;
    const response = await fetch(`/api/delete_category/${currentCategoryId}`, { method: "DELETE" });

    if (response.ok) {
      const dropdown = document.getElementById("category");
      dropdown.remove(dropdown.selectedIndex);
      bootstrap.Modal.getInstance(document.getElementById("deleteCategoryModal")).hide();
      showToast("üóë Category deleted!", true);
      document.getElementById("linksGrid").innerHTML = "<p class='text-muted'>No category selected yet.</p>";
    } else {
      const error = await response.json();
      showToast("‚ö† " + error.error, true);
    }
  }

  // Delete/Undo link
  async function deleteLink(id, label, url, categoryId) {
    const response = await fetch(`/api/delete_link/${id}`, { method: "DELETE" });
    if (response.ok) {
      document.getElementById(`undo-${id}`).classList.remove("d-none");
      showToast("üóë Link deleted. Click undo to restore.", true);
      showLinks();
    }
  }

  async function undoLink(categoryId, label, url, id) {
    const response = await fetch("/api/undo_link", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ category_id: categoryId, label, url })
    });

    if (response.ok) {
      document.getElementById(`undo-${id}`).classList.add("d-none");
      showToast("‚úÖ Link restored!");
      showLinks();
    }
  }

  // Toast helper
  function showToast(message, isError = false) {
    const toastEl = document.getElementById("toastMsg");
    const toastBody = document.getElementById("toastBody");
    toastBody.textContent = message;
    toastEl.classList.remove("text-bg-success", "text-bg-danger");
    toastEl.classList.add(isError ? "text-bg-danger" : "text-bg-success");
    new bootstrap.Toast(toastEl).show();
  }

  // Alphabetical sort on load
  document.addEventListener("DOMContentLoaded", () => {
    const dropdown = document.getElementById("category");
    const options = [...dropdown.options].sort((a, b) => a.text.localeCompare(b.text));
    dropdown.innerHTML = "";
    options.forEach(opt => dropdown.appendChild(opt));
  });

  // Export links of selected category
  function exportLinks() {
    const catSelect = document.getElementById("category");
    const catId = catSelect.value;
    if (!catId) {
      showToast("‚ö† Please select a category first", true);
      return;
    }
    window.location.href = `/api/export_links/${catId}`;
  }

  // Export all categories
  function exportCategories() {
    window.location.href = `/api/export_categories`;
  }
</script>
{% endblock %}
